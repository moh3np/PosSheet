<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        direction: rtl;
        background:#fafafa;
        padding:20px;
      }
      .product {
        margin-bottom: 15px;
        padding:10px;
        border:1px solid #ccc;
        border-radius:8px;
        background:#fff;
      }
      .label {
        display:inline-block;
        width:110px;
        font-weight:bold;
      }
      #products input.sn {
        width:100%;
        font-size:18px;
        text-align:center;
        padding:8px;
        margin-bottom:10px;
        border-radius:6px;
        border:1px solid #aaa;
      }
      .priceInput {
        width:150px;
        padding:4px;
        border-radius:4px;
        border:1px solid #aaa;
      }
      #totalDiv {
        margin-top:20px;
        font-size:20px;
        font-weight:bold;
      }
      #finalAmountDiv {
        margin-top:10px;
        font-size:18px;
      }
      #finalAmount {
        width:200px;
        padding:4px;
        border-radius:4px;
        border:1px solid #aaa;
      }
    </style>
  </head>
  <body>
    <div id="products"></div>
    <div id="totalDiv">
      جمع کل: <span id="total">0</span> تومان
    </div>
    <div id="finalAmountDiv">
      مبلغ نهایی: <input id="finalAmount" type="text" value="0">
    </div>

    <script>
    var products = [];
    var container;

    function toEnglishNumber(str) {
      return str.replace(/[\u06F0-\u06F9]/g, function(d){return d.charCodeAt(0)-1728;})
                .replace(/[\u0660-\u0669]/g, function(d){return d.charCodeAt(0)-1584;});
    }

    function toFarsiNumber(str) {
      return str.replace(/\d/g, function(d){return '۰۱۲۳۴۵۶۷۸۹'[d];});
    }

    function formatNumber(num) {
      var str = Number(num || 0).toLocaleString('en-US');
      return toFarsiNumber(str);
    }

    function parseNumber(val){
      val = toEnglishNumber(val).replace(/,/g,'');
      return Number(val) || 0;
    }

      function addInput() {
        var input = document.createElement('input');
        input.type = 'text';
        input.className = 'sn';
        input.placeholder = 'کد محصول';
        input.addEventListener('keyup', function(e) {
          if (e.key === 'Enter') { searchProduct(input); }
        });
        container.appendChild(input);
        input.focus();
      }

      function searchProduct(input) {
        var sn = toEnglishNumber(input.value);
        if (!sn) return;
        google.script.run.withSuccessHandler(function(res) {
          if (!res) {
            alert('یافت نشد');
            return;
          }
          var div = document.createElement('div');
          div.className = 'product';
          var locationText = (res.location === 'STORE') ? 'مغازه' : (res.location || '-');
          var priceVal = parseNumber(res.price);
          div.innerHTML = '<span class="label">نام محصول:</span><span>' + (res.name || '-') + '</span>'+
            '<br><span class="label">برند:</span><span>' + (res.brand || '-') + '</span>'+
            '<br><span class="label">قیمت:</span><input type="text" class="priceInput" value="' + formatNumber(priceVal) + '" data-val="' + priceVal + '"> تومان'+
            '<br><span class="label">موقعیت:</span><span>' + locationText + '</span>';
          container.insertBefore(div, input.nextSibling);
          var priceInput = div.querySelector('.priceInput');
          priceInput.addEventListener('focus', function(){ this.value = this.dataset.val; });
          priceInput.addEventListener('blur', function(){ this.dataset.val = parseNumber(this.value); this.value = formatNumber(this.dataset.val); updateTotal(); });
          priceInput.addEventListener('input', function(){ this.dataset.val = parseNumber(this.value); });
          products.push({priceInput: priceInput});
          updateTotal();
          input.value = '';
        }).searchInventory(sn);
      }

      function updateTotal() {
        var total = products.reduce(function(sum, p){ return sum + parseNumber(p.priceInput.dataset.val || p.priceInput.value || 0); }, 0);
        document.getElementById('total').textContent = formatNumber(total);
        var finalInput = document.getElementById('finalAmount');
        if (document.activeElement !== finalInput) {
          finalInput.dataset.val = total;
          finalInput.value = formatNumber(total);
        }
      }

      window.onload = function() {
        container = document.getElementById('products');
        addInput();
        var finalInput = document.getElementById('finalAmount');
        finalInput.dataset.val = 0;
        finalInput.addEventListener('focus', function(){ this.value = this.dataset.val; });
        finalInput.addEventListener('blur', function(){ this.dataset.val = parseNumber(this.value); this.value = formatNumber(this.dataset.val); });
      }
    </script>
  </body>
</html>
