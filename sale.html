<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        direction: rtl;
        background:#f5f5f5;
        padding:20px;
        padding-bottom:200px;
      }
      .product {
        margin-bottom: 15px;
        padding:10px;
        border:1px solid #ccc;
        border-radius:8px;
        background:#fff;
      }
      .label {
        display:inline-block;
        width:110px;
        font-weight:bold;
      }
      #products .sn {
        width:30%;
        font-size:18px;
        text-align:center;
        display:block;
        margin:0 auto 10px;
        padding:8px;
        border-radius:6px;
        border:1px solid #aaa;
        position: sticky;
        top: 0;
        background:#fff;
        z-index: 1;
      }
      .priceInput {
        width:150px;
        padding:4px;
        border-radius:4px;
        border:1px solid #aaa;
        text-align:center;
        font-weight:bold;
      }
      #productTable {
        width:100%;
        border-collapse:collapse;
        margin-top:15px;
      }
      #productTable th, #productTable td {
        border:1px solid #ccc;
        padding:8px;
        text-align:center;
      }
      #productTable th {
        background:#eee;
      }
      #productTable td.price {
        font-weight:bold;
      }
      #totals {
        position: fixed;
        left: 0;
        right: 0;
        bottom:60px;
        background:#fff;
        border-top:1px solid #ccc;
      }
      #totalDiv, #finalAmountDiv {
        padding:10px;
        text-align:center;
        border-top:1px solid #ccc;
      }
      #totalDiv {
        font-size:20px;
        font-weight:bold;
      }
      #finalAmountDiv {
        font-size:18px;
      }
      #finalAmount {
        width:200px;
        padding:4px;
        border-radius:4px;
        border:1px solid #aaa;
        text-align:center;
        font-weight:bold;
      }
      #footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background:#fff;
        border-top:1px solid #ccc;
        text-align:center;
        padding:10px;
      }
      #footer button {
        padding:10px 20px;
        margin:0 5px;
        border:none;
        border-radius:4px;
        font-size:16px;
        cursor:pointer;
      }
      #footer button.submit {
        background:#4caf50;
        color:#fff;
      }
      #footer button.cancel {
        background:#f44336;
        color:#fff;
      }
    </style>
  </head>
  <body>
    <div id="products">
      <input class="sn" list="productList" placeholder="جستجوی محصول">
      <table id="productTable">
        <thead>
          <tr>
            <th>محصول</th>
            <th>سریال</th>
            <th>موقعیت</th>
            <th>قیمت</th>
            <th>قیمت با تخفیف</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <datalist id="productList"></datalist>
    <div id="totals">
      <div id="totalDiv">
        جمع کل: <span id="total">0</span> تومان
      </div>
      <div id="finalAmountDiv">
        مبلغ نهایی: <input id="finalAmount" type="text" value="0"> تومان
      </div>
    </div>
    <div id="footer">
      <button class="submit">ثبت</button>
      <button class="cancel" onclick="google.script.host.close()">لغو</button>
    </div>
    <script>
      const inventoryData = <?!= JSON.stringify(inventoryData) ?>;
      const snIndex = inventoryData.sns.reduce((o, sn, i) => (o[sn] = i, o), {});
      const nameIndex = inventoryData.names.reduce((o, name, i) => (o[name.toLowerCase()] = i, o), {});
      const productList = document.getElementById('productList');
      inventoryData.sns.forEach(sn => {
        const opt = document.createElement('option');
        opt.value = sn;
        productList.appendChild(opt);
      });
      inventoryData.names.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        productList.appendChild(opt);
      });
      const snInput = document.querySelector('.sn');
      const tbody = document.querySelector('#productTable tbody');
      const totalEl = document.getElementById('total');
      const finalAmountInput = document.getElementById('finalAmount');
      const addedSerials = new Set();

      const persianDigits = '۰۱۲۳۴۵۶۷۸۹';
      function formatNumber(num){
        return Number(num || 0).toLocaleString('fa-IR').replace(/٬/g, ',');
      }
      function parseNumber(str){
        return Number(String(str).replace(/,/g, '').replace(/[۰-۹]/g, d => persianDigits.indexOf(d))) || 0;
      }

      let total = 0;
      totalEl.textContent = formatNumber(total);
      finalAmountInput.value = formatNumber(total);

      function updateTotals(){
        total = Array.from(document.querySelectorAll('.discount'))
          .reduce((sum, input) => sum + parseNumber(input.value), 0);
        totalEl.textContent = formatNumber(total);
        finalAmountInput.value = formatNumber(total);
      }

      snInput.addEventListener('keydown', function(e){
        if(e.key === 'Enter'){
          const query = snInput.value.trim();
          if(!query) return;
          let idx = snIndex[query];
          if(idx === undefined){
            idx = nameIndex[query.toLowerCase()];
          }
          if(idx !== undefined){
            const serial = inventoryData.sns[idx];
            if (addedSerials.has(serial)) {
              snInput.value = '';
              return;
            }
            const price = Number(inventoryData.prices[idx]) || 0;
            const location = inventoryData.locations[idx] === 'STORE' ? 'مغازه' : inventoryData.locations[idx];
            const row = document.createElement('tr');
            row.innerHTML = `<td>${inventoryData.names[idx]}</td><td>${serial}</td><td>${location}</td><td class="price">${formatNumber(price)}</td><td><input class="priceInput discount" type="text" value="${formatNumber(price)}"></td>`;
            tbody.appendChild(row);
            addedSerials.add(serial);
            const discountInput = row.querySelector('.discount');
            discountInput.addEventListener('input', function(){
              const val = parseNumber(discountInput.value);
              discountInput.value = formatNumber(val);
              updateTotals();
            });
            updateTotals();
            snInput.value = '';
          }
        }
      });

      finalAmountInput.addEventListener('input', function(){
        const val = parseNumber(finalAmountInput.value);
        finalAmountInput.value = formatNumber(val);
      });
    </script>
  </body>
</html>
