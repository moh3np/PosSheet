<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        direction: rtl;
        background:#f5f5f5;
        padding:20px;
        padding-bottom:150px;
      }
      #orderSearch {
        width:30%;
        font-size:18px;
        text-align:center;
        display:block;
        margin:0 auto 10px;
        padding:8px;
        border-radius:6px;
        border:1px solid #aaa;
        position:sticky;
        top:0;
        background:#fff;
        z-index:1;
      }
      table {
        width:100%;
        border-collapse:collapse;
        margin-top:15px;
      }
      th, td {
        border:1px solid #ccc;
        padding:8px;
        text-align:center;
      }
      tr.selected {
        background:#ffe0e0;
      }
      tr {
        cursor:pointer;
      }
      tr.cancelled {
        background:#e0e0e0;
        color:#888;
        cursor:default;
      }
      .discount-info {
        font-size:12px;
        color:#d32f2f;
      }
      #totals {
        position:fixed;
        left:0;
        right:0;
        bottom:60px;
        background:#fff;
        border-top:1px solid #ccc;
      }
      #totalDiv {
        padding:10px;
        text-align:center;
        font-size:20px;
        font-weight:bold;
      }
      #footer {
        position:fixed;
        bottom:0;
        left:0;
        right:0;
        background:#fff;
        border-top:1px solid #ccc;
        text-align:center;
        padding:10px;
      }
      #footer button {
        padding:10px 20px;
        margin:0 5px;
        border:none;
        border-radius:4px;
        background:#f44336;
        color:#fff;
        cursor:pointer;
      }
      td.date-cell {
        direction: ltr;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <input id="orderSearch" type="text" placeholder="جستجو سفارش" autofocus>
    <table id="orderTable">
      <thead>
        <tr>
          <th>انتخاب</th>
          <th>شماره سفارش</th>
          <th>تاریخ</th>
          <th>نام محصول</th>
          <th>سریال</th>
          <th>قیمت محصول</th>
          <th>مبلغ پرداختی</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="totals">
      <div id="totalDiv">جمع کل: <span id="total">۰</span> تومان</div>
    </div>
    <div id="footer">
      <button id="cancelBtn">لغو سفارش</button>
    </div>
    <script>
      const orderData = <?!= JSON.stringify(orderData) ?>;
      const tbody = document.querySelector('#orderTable tbody');
      const totalEl = document.getElementById('total');
      const selectedMap = new Map(); // sn -> sku
      const MAX_DISPLAY = 200;
      const persianDigits = '۰۱۲۳۴۵۶۷۸۹';

      function startTimer(name){
        const start = performance.now();
        return () => console.log(name + ' took ' + (performance.now() - start).toFixed(2) + 'ms');
      }

      function addTiming(names){
        names.forEach(name => {
          const fn = window[name];
          if (typeof fn === 'function'){
            window[name] = function(...args){
              const end = startTimer(name);
              try {
                return fn.apply(this, args);
              } finally {
                end();
              }
            };
          }
        });
      }

      function formatNumber(num){
        return Number(num || 0).toLocaleString('fa-IR').replace(/٬/g, ',');
      }
      function toEnglishDigits(str){
        return String(str).replace(/[۰-۹]/g, d => persianDigits.indexOf(d));
      }
      function toPersianDigits(str){
        return String(str).replace(/\d/g, d => persianDigits[d]);
      }
      function formatDateStr(str){
        if(!str) return '';
        const d = new Date(str);
        if(isNaN(d)) return str;
        const pad = n => n.toString().padStart(2,'0');
        const formatted = d.getFullYear() + '/' + pad(d.getMonth()+1) + '/' + pad(d.getDate()) + ' ' +
               pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());
        return toPersianDigits(formatted);
      }

      const allIndices = orderData.ids.map((_,i)=>i);

      function renderRows(indices){
        tbody.innerHTML = '';
        indices.slice(0, MAX_DISPLAY).forEach(i => {
          const tr = document.createElement('tr');
          const sn = String(orderData.sns[i]);
          const sku = String(orderData.skus[i] || '');
          tr.dataset.sn = sn;
          tr.dataset.sku = sku;
          tr.dataset.paid = orderData.paidPrices[i] || 0;
          const chkTd = document.createElement('td');
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.checked = selectedMap.has(sn);
          chkTd.appendChild(chk);
          tr.appendChild(chkTd);
          const date = formatDateStr(orderData.persianDates[i] || orderData.dates[i] || '');
          const fields = [
            orderData.ids[i],
            date,
            orderData.names[i],
            orderData.sns[i],
            orderData.prices[i],
            orderData.paidPrices[i]
          ];
          fields.forEach((f, idx) => {
            const td = document.createElement('td');
            if (idx >= 4) {
              td.textContent = formatNumber(f);
              if (idx === 5) {
                const diff = Number(orderData.prices[i]) - Number(orderData.paidPrices[i]);
                if (diff > 0 && Number(orderData.prices[i])) {
                  const pct = Math.round(diff / Number(orderData.prices[i]) * 100);
                  const info = document.createElement('div');
                  info.className = 'discount-info';
                  info.textContent = '-' + formatNumber(diff) + ' (' + formatNumber(pct) + '%)';
                  td.appendChild(info);
                }
              }
            } else {
              td.textContent = f;
            }
            if (idx === 1) {
              td.classList.add('date-cell');
            }
            tr.appendChild(td);
          });
          if (!orderData.cancellations[i]) {
            chk.addEventListener('click', e => {
              e.stopPropagation();
              toggle(sn, sku, chk.checked, tr);
            });
            tr.addEventListener('click', () => {
              const checked = !chk.checked;
              chk.checked = checked;
              toggle(sn, sku, checked, tr);
              const search = document.getElementById('orderSearch');
              if (search.value) {
                search.value = '';
                renderRows(allIndices);
                search.focus();
              }
            });
          } else {
            chk.disabled = true;
            tr.classList.add('cancelled');
          }
          tr.classList.toggle('selected', chk.checked);
          tbody.appendChild(tr);
        });
        updateTotal();
      }

      function toggle(sn, sku, checked, tr){
        tr.classList.toggle('selected', checked);
        if (checked) {
          selectedMap.set(sn, sku);
        } else {
          selectedMap.delete(sn);
        }
        updateTotal();
      }

      function updateTotal(){
        let sum = 0;
        tbody.querySelectorAll('input[type="checkbox"]:checked').forEach(chk => {
          const tr = chk.closest('tr');
          sum += Number(tr.dataset.paid) || 0;
        });
        totalEl.textContent = formatNumber(sum);
      }

      function filterOrders(){
        const q = document.getElementById('orderSearch').value.trim().toLowerCase();
        const en = toEnglishDigits(q);
        const filtered = allIndices.filter(i => {
          const name = (orderData.names[i] || '').toLowerCase();
          const date = formatDateStr(orderData.persianDates[i] || orderData.dates[i] || '').split(' ')[0];
          const data = [
            orderData.ids[i], orderData.persianIds[i],
            orderData.sns[i], orderData.persianSNS[i],
            name, orderData.brands[i],
            date
          ].join(' ');
          const dataEn = toEnglishDigits(data);
          return data.indexOf(q) > -1 || dataEn.indexOf(en) > -1;
        });
        renderRows(filtered);
      }

      document.getElementById('orderSearch').addEventListener('input', filterOrders);
      document.getElementById('orderSearch').focus();

      renderRows(allIndices);

      document.getElementById('cancelBtn').addEventListener('click', () => {
        const end = startTimer('cancelOrders');
        const selected = Array.from(selectedMap.entries())
          .map(([sn, sku]) => ({ sn, sku }));
        google.script.run.withSuccessHandler(() => {
          end();
          google.script.host.close();
        }).cancelOrders(selected);
      });

      addTiming(['formatNumber','toEnglishDigits','toPersianDigits','formatDateStr','renderRows','toggle','updateTotal','filterOrders']);
    </script>
  </body>
</html>
