<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        direction: rtl;
        padding:20px;
        padding-bottom:200px;
      }
      #orderSearch {
        width:30%;
        font-size:18px;
        text-align:center;
        display:block;
        margin:0 auto 10px;
        padding:8px;
        border-radius:6px;
        border:1px solid #aaa;
        position: sticky;
        top: 0;
        background:#fff;
        z-index:1;
      }
      table {
        width:100%;
        border-collapse:collapse;
        margin-top:15px;
      }
      th, td {
        border:1px solid #ccc;
        padding:8px;
        text-align:center;
      }
      tr.selected {
        background:#ffe0e0;
      }
      tr {
        cursor:pointer;
      }
      .discount-info {
        font-size:12px;
        color:#d32f2f;
      }
      #totals {
        position: fixed;
        left: 0;
        right: 0;
        bottom:60px;
        background:#fff;
        border-top:1px solid #ccc;
        padding:10px;
        text-align:center;
        font-weight:bold;
      }
      #footer {
        position: fixed;
        bottom:0;
        left:0;
        right:0;
        background:#fff;
        border-top:1px solid #ccc;
        text-align:center;
        padding:10px;
      }
      #footer button {
        padding:10px 20px;
        border:none;
        border-radius:4px;
        background:#f44336;
        color:#fff;
        cursor:pointer;
      }
    </style>
  </head>
  <body>
    <input id="orderSearch" type="text" placeholder="جستجو سفارش" autofocus>
    <table id="orderTable">
      <thead>
        <tr>
          <th>انتخاب</th>
          <th>شماره سفارش</th>
          <th>تاریخ</th>
          <th>نام محصول</th>
          <th>سریال</th>
          <th>قیمت محصول</th>
          <th>مبلغ پرداختی</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="totals">
      جمع کل مبلغ پرداختی: <span id="total">۰</span> تومان
    </div>
    <div id="footer">
      <button id="cancelBtn">لغو سفارش</button>
    </div>
    <script>
      const orderData = <?!= JSON.stringify(orderData) ?>;
      const tbody = document.querySelector('#orderTable tbody');
      const MAX_ROWS = 200;

      function toEnglishDigits(str){
        const persian = '۰۱۲۳۴۵۶۷۸۹';
        return String(str).replace(/[۰-۹]/g, d => persian.indexOf(d));
      }
      function toPersianDigits(str){
        const persian = '۰۱۲۳۴۵۶۷۸۹';
        return String(str).replace(/[0-9]/g, d => persian[d]);
      }
      function formatPrice(num){
        const n = Number(num) || 0;
        return toPersianDigits(n.toLocaleString('en-US'));
      }
      function updateTotal(){
        const total = Array.from(tbody.querySelectorAll('tr')).reduce((sum, row) => {
          const chk = row.querySelector('input[type="checkbox"]');
          if(chk.checked){
            const val = Number(row.querySelector('.paid-price').dataset.value);
            return sum + val;
          }
          return sum;
        }, 0);
        document.getElementById('total').textContent = formatPrice(total);
      }

      orderData.ids.forEach((id, i) => {
        if(i >= MAX_ROWS) return;
        const tr = document.createElement('tr');
        tr.dataset.id = orderData.ids[i];
        const chkTd = document.createElement('td');
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chkTd.appendChild(chk);
        tr.appendChild(chkTd);
        const fields = [orderData.ids[i], orderData.dates[i], orderData.names[i], orderData.sns[i], orderData.prices[i], orderData.paidPrices[i]];
        fields.forEach((f, idx) => {
          const td = document.createElement('td');
          if (idx === 4 || idx === 5) {
            td.textContent = formatPrice(f);
            td.dataset.value = Number(f) || 0;
            if (idx === 5) {
              td.className = 'paid-price';
              const diff = Number(orderData.prices[i]) - Number(orderData.paidPrices[i]);
              if (diff > 0 && Number(orderData.prices[i])) {
                const pct = Math.round(diff / Number(orderData.prices[i]) * 100);
                const info = document.createElement('div');
                info.className = 'discount-info';
                info.textContent = '-' + formatPrice(diff) + ' (' + toPersianDigits(pct) + '%)';
                td.appendChild(info);
              }
            }
          } else {
            td.textContent = f;
          }
          tr.appendChild(td);
        });
        tr.addEventListener('click', (e) => {
          if (e.target.tagName !== 'INPUT') chk.checked = !chk.checked;
          tr.classList.toggle('selected', chk.checked);
          updateTotal();
          const search = document.getElementById('orderSearch');
          if (search.value) {
            search.value = '';
            filterOrders();
            search.focus();
          }
        });
        tbody.appendChild(tr);
      });

      function filterOrders(){
        const q = document.getElementById('orderSearch').value.trim().toLowerCase();
        const en = toEnglishDigits(q);
        Array.from(tbody.rows).forEach((row, i) => {
          const data = [
            orderData.ids[i], orderData.persianIds[i],
            orderData.sns[i], orderData.persianSNS[i],
            orderData.names[i].toLowerCase(),
            orderData.dates[i].split(' ')[0],
            orderData.persianDates[i] ? orderData.persianDates[i].split(' ')[0] : ''
          ].join(' ');
          const dataEn = toEnglishDigits(data);
          const show = data.indexOf(q) > -1 || dataEn.indexOf(en) > -1;
          row.style.display = show ? '' : 'none';
        });
      }
      document.getElementById('orderSearch').addEventListener('input', filterOrders);
      document.getElementById('orderSearch').focus();
      document.getElementById('cancelBtn').addEventListener('click', () => {
        const selected = Array.from(tbody.querySelectorAll('input[type="checkbox"]')).filter(c => c.checked).map(c => c.closest('tr').dataset.id);
        google.script.run.withSuccessHandler(() => google.script.host.close()).cancelOrders(selected);
      });
    </script>
  </body>
</html>
