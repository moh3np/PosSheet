<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        direction: rtl;
        background:#f5f5f5;
        padding:20px;
        padding-bottom:150px;
      }
      #orderSearch {
        width:30%;
        font-size:18px;
        text-align:center;
        display:block;
        margin:0 auto 10px;
        padding:8px;
        border-radius:6px;
        border:1px solid #aaa;
        position:sticky;
        top:0;
        background:#fff;
        z-index:1;
      }
      table {
        width:100%;
        border-collapse:collapse;
        margin-top:15px;
      }
      th, td {
        border:1px solid #ccc;
        padding:8px;
        text-align:center;
      }
      tr.selected {
        background:#ffe0e0;
      }
      tr {
        cursor:pointer;
      }
      .discount-info {
        font-size:12px;
        color:#d32f2f;
      }
      #totals {
        position:fixed;
        left:0;
        right:0;
        bottom:60px;
        background:#fff;
        border-top:1px solid #ccc;
      }
      #totalDiv {
        padding:10px;
        text-align:center;
        font-size:20px;
        font-weight:bold;
      }
      #footer {
        position:fixed;
        bottom:0;
        left:0;
        right:0;
        background:#fff;
        border-top:1px solid #ccc;
        text-align:center;
        padding:10px;
      }
      #footer button {
        padding:10px 20px;
        margin:0 5px;
        border:none;
        border-radius:4px;
        background:#f44336;
        color:#fff;
        cursor:pointer;
      }
    </style>
  </head>
  <body>
    <input id="orderSearch" type="text" placeholder="جستجو سفارش" autofocus>
    <table id="orderTable">
      <thead>
        <tr>
          <th>انتخاب</th>
          <th>شماره سفارش</th>
          <th>تاریخ</th>
          <th>نام محصول</th>
          <th>سریال</th>
          <th>قیمت محصول</th>
          <th>مبلغ پرداختی</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="totals">
      <div id="totalDiv">جمع کل: <span id="total">۰</span> تومان</div>
    </div>
    <div id="footer">
      <button id="cancelBtn">لغو سفارش</button>
    </div>
    <script>
      const orderData = <?!= JSON.stringify(orderData) ?>;
      const tbody = document.querySelector('#orderTable tbody');
      const totalEl = document.getElementById('total');
      const selectedIds = new Set();
      const idIndex = orderData.ids.reduce((o,id,i)=>(o[id]=i,o),{});
      const MAX_DISPLAY = 200;
      const persianDigits = '۰۱۲۳۴۵۶۷۸۹';

      function formatNumber(num){
        return Number(num || 0).toLocaleString('fa-IR').replace(/٬/g, ',');
      }
      function toEnglishDigits(str){
        return String(str).replace(/[۰-۹]/g, d => persianDigits.indexOf(d));
      }
      function formatDateStr(str){
        if(!str) return '';
        const d = new Date(str);
        if(isNaN(d)) return str;
        const pad = n => n.toString().padStart(2,'0');
        return d.getFullYear() + '/' + pad(d.getMonth()+1) + '/' + pad(d.getDate()) + ' ' +
               pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());
      }

      const allIndices = orderData.ids.map((_,i)=>i);

      function renderRows(indices){
        tbody.innerHTML = '';
        indices.slice(0, MAX_DISPLAY).forEach(i => {
          const tr = document.createElement('tr');
          tr.dataset.id = orderData.ids[i];
          const chkTd = document.createElement('td');
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.checked = selectedIds.has(orderData.ids[i]);
          chk.addEventListener('click', e => {
            e.stopPropagation();
            toggle(orderData.ids[i], chk.checked, tr);
          });
          chkTd.appendChild(chk);
          tr.appendChild(chkTd);
          const date = formatDateStr(orderData.persianDates[i] || orderData.dates[i] || '');
          const fields = [
            orderData.ids[i],
            date,
            orderData.names[i],
            orderData.sns[i],
            orderData.prices[i],
            orderData.paidPrices[i]
          ];
          fields.forEach((f, idx) => {
            const td = document.createElement('td');
            if (idx >= 4) {
              td.textContent = formatNumber(f);
              if (idx === 5) {
                const diff = Number(orderData.prices[i]) - Number(orderData.paidPrices[i]);
                if (diff > 0 && Number(orderData.prices[i])) {
                  const pct = Math.round(diff / Number(orderData.prices[i]) * 100);
                  const info = document.createElement('div');
                  info.className = 'discount-info';
                  info.textContent = '-' + formatNumber(diff) + ' (' + formatNumber(pct) + '%)';
                  td.appendChild(info);
                }
              }
            } else {
              td.textContent = f;
            }
            tr.appendChild(td);
          });
          tr.addEventListener('click', () => {
            const checked = !chk.checked;
            chk.checked = checked;
            toggle(orderData.ids[i], checked, tr);
            const search = document.getElementById('orderSearch');
            if (search.value) {
              search.value = '';
              renderRows(allIndices);
              search.focus();
            }
          });
          tr.classList.toggle('selected', chk.checked);
          tbody.appendChild(tr);
        });
        updateTotal();
      }

      function toggle(id, checked, tr){
        tr.classList.toggle('selected', checked);
        if (checked) {
          selectedIds.add(id);
        } else {
          selectedIds.delete(id);
        }
        updateTotal();
      }

      function updateTotal(){
        let sum = 0;
        selectedIds.forEach(id => {
          const i = idIndex[id];
          sum += Number(orderData.paidPrices[i]) || 0;
        });
        totalEl.textContent = formatNumber(sum);
      }

      function filterOrders(){
        const q = document.getElementById('orderSearch').value.trim().toLowerCase();
        const en = toEnglishDigits(q);
        const filtered = allIndices.filter(i => {
          const name = (orderData.names[i] || '').toLowerCase();
          const date = formatDateStr(orderData.persianDates[i] || orderData.dates[i] || '').split(' ')[0];
          const data = [
            orderData.ids[i], orderData.persianIds[i],
            orderData.sns[i], orderData.persianSNS[i],
            name,
            date
          ].join(' ');
          const dataEn = toEnglishDigits(data);
          return data.indexOf(q) > -1 || dataEn.indexOf(en) > -1;
        });
        renderRows(filtered);
      }

      document.getElementById('orderSearch').addEventListener('input', filterOrders);
      document.getElementById('orderSearch').focus();

      renderRows(allIndices);

      document.getElementById('cancelBtn').addEventListener('click', () => {
        const selected = Array.from(selectedIds);
        google.script.run.withSuccessHandler(() => google.script.host.close()).cancelOrders(selected);
      });
    </script>
  </body>
</html>
